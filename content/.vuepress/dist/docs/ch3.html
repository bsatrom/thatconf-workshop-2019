<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Chapter 3: Using Particle Webhooks with IFTTT &amp; azure IoT Central | Particle Argon Workshop</title>
    <meta name="description" content="Workshops designed to teach the basics of IoT development with the Particle ecosystem &amp; the Particle Argon">
    
    
    <link rel="preload" href="/assets/css/6.styles.b7d182e7.css" as="style"><link rel="preload" href="/assets/js/app.1eff5426.js" as="script"><link rel="preload" href="/assets/js/1.5a60c874.js" as="script"><link rel="prefetch" href="/assets/js/0.e219634f.js"><link rel="prefetch" href="/assets/js/2.211a9182.js"><link rel="prefetch" href="/assets/js/3.938dc8d4.js"><link rel="prefetch" href="/assets/js/4.07300372.js"><link rel="prefetch" href="/assets/js/5.29741ec5.js">
    <link rel="stylesheet" href="/assets/css/6.styles.b7d182e7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      Particle Argon Workshop
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="http://particle.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Team
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><a href="https://github.com/bsatrom/thatconf-workshop-2019" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="http://particle.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Team
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><a href="https://github.com/bsatrom/thatconf-workshop-2019" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><a href="/docs/" class="sidebar-link">About Particle Workshops</a></li><li><a href="/docs/ch1.html" class="sidebar-link">Chapter 1: Getting your Particle Argon online</a></li><li><a href="/docs/ch2.html" class="sidebar-link">Chapter 2: Working with Particle primitives &amp; Grove Sensors</a></li><li><a href="/docs/ch3.html" class="active sidebar-link">Chapter 3: Using Particle Webhooks &amp; Integrations</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/ch3.html#exploring-the-particle-cli-and-cloud-api" class="sidebar-link">Exploring the Particle CLI and Cloud API</a></li><li class="sidebar-sub-header"><a href="/docs/ch3.html#introducing-the-particle-integrations-and-ifttt" class="sidebar-link">Introducing the Particle Integrations and IFTTT</a></li><li class="sidebar-sub-header"><a href="/docs/ch3.html#integrating-with-azure-iot-central" class="sidebar-link">Integrating with Azure IoT Central</a></li></ul></li><li><a href="/docs/extra.html" class="sidebar-link">Extra: Going Even Further!</a></li></ul></div><div class="page"><div class="content"><h1 id="chapter-3-using-particle-webhooks-with-ifttt-azure-iot-central"><a href="#chapter-3-using-particle-webhooks-with-ifttt-azure-iot-central" aria-hidden="true" class="header-anchor">#</a> Chapter 3: Using Particle Webhooks with IFTTT &amp; azure IoT Central</h1><table><thead><tr><th><strong>Project Goal</strong></th><th>Use Particle Webhooks and Integrations to connect your app to IFTTT and Azure IoT Central.</th></tr></thead><tbody><tr><td><strong>What you’ll learn</strong></td><td>Working with Particle Integrations, IFTTT, and Azure IoT Central</td></tr><tr><td><strong>Tools you’ll need</strong></td><td>Particle Workbench, an <a href="https://ifttt.com" target="_blank" rel="noopener noreferrer">IFTTT.com<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> account, an <a href="https://portal.azure.com" target="_blank" rel="noopener noreferrer">Azure account<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, a Particle Argon, and the Grove Starter Kit for Particle Mesh.</td></tr><tr><td><strong>Time needed to complete</strong></td><td>60 minutes</td></tr></tbody></table><p>In this session, you're going to explore the power of Particle integrations, first with the popular IF This Then That (IFTTT) service, then with Azure IoT Central. If you get stuck at any point during this session, <a href="https://go.particle.io/shared_apps/5d40aec2279e1e000b9ad57b" target="_blank" rel="noopener noreferrer">click here for the completed, working source<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p><h2 id="exploring-the-particle-cli-and-cloud-api"><a href="#exploring-the-particle-cli-and-cloud-api" aria-hidden="true" class="header-anchor">#</a> Exploring the Particle CLI and Cloud API</h2><h3 id="the-particle-cli"><a href="#the-particle-cli" aria-hidden="true" class="header-anchor">#</a> The Particle CLI</h3><ol><li>If you haven't already, <a href="https://docs.particle.io/guide/tools-and-features/cli/photon/" target="_blank" rel="noopener noreferrer">install the Particle CLI<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Open a terminal window and type the following command:</li></ol><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">bash</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span> <span class="token function">curl</span> -sL https://particle.io/install-cli <span class="token punctuation">)</span>
</code></pre></div><ol start="2"><li>Type <code>particle login</code> and enter your Particle account email and password when prompted.</li></ol><p><img src="/assets/img/particlelogin.14fc48ea.gif" alt></p><ol start="3"><li>Once you're logged in, type <code>particle list</code> to see your list of online devices.</li></ol><p><img src="/assets/img/particlelist.085a96a6.gif" alt></p><ol start="4"><li>The device you've been using for this workshop has two variables and one function. Get the value of the <code>temp</code> variable with the command <code>particle get temp</code>.</li></ol><p><img src="/assets/img/temp.61c682e4.gif" alt></p><ol start="5"><li>You can also call one of the two functions to light up the yellow or blue LED button. Type the command <code>particle call &lt;your-device-name&gt; toggleLed</code> in the terminal. Run the same command again to turn the light off.</li></ol><h3 id="the-particle-device-cloud-api"><a href="#the-particle-device-cloud-api" aria-hidden="true" class="header-anchor">#</a> The Particle Device Cloud API</h3><p>Behind the scenes, every interface that Particle provides to work with devices, from the Console, to mobile apps, SDKs, and the CLI, they all talk through a RESTful Device Cloud API. You can even call yourself, directly.</p><p><em>The next few steps assume you have cURL installed on your machine. If you don't have this command-line utility on your machine, you can download and install it <a href="https://curl.haxx.se/download.html" target="_blank" rel="noopener noreferrer">here<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> or use a GUI-based tool like <a href="https://www.getpostman.com/" target="_blank" rel="noopener noreferrer">Postman<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</em></p><ol><li><p>First, you'll need to obtain an access token from the CLI. Type <code>particle token list</code> to view the tokens associated with your account. The first one listed is your <code>user</code> token, and can be used to access the Device Cloud API. If no tokens are listed, generate a new one with <code>particle token new</code>.</p></li><li><p>With your token and Device ID in hand, type the following cURL command into a terminal window, replacing the text below in <code>&lt; &gt;</code> with your information.</p></li></ol><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">curl</span> https://api.particle.io/v1/devices?access_token<span class="token operator">=</span><span class="token operator">&lt;</span>your token<span class="token operator">&gt;</span>
</code></pre></div><p>By default, the response will generate a wall of text in your terminal. If you have Python 2.6+ installed on your machine, you can pipe the output to the <code>json.tool</code> and get pretty-printed JSON.</p><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">curl</span> https://api.particle.io/v1/devices\?access_token\<span class="token operator">=</span><span class="token operator">&lt;</span>your token<span class="token operator">&gt;</span>
<span class="token operator">|</span> python -m json.tool
</code></pre></div><p><img src="/assets/img/curllist.d0d65fc2.gif" alt></p><ol start="3"><li><p>For this next command, you need the Device ID of the Photon attached to your badge. You can find that in the console or via the <code>particle list</code> CLI command.</p></li><li><p>Let's call the <code>toggleLed</code> function using the Device Cloud API. Type the following, again replacing the text below in <code>&lt; &gt;</code> with your information.</p></li></ol><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">curl</span> https://api.particle.io/v1/devices/<span class="token operator">&lt;</span>device id<span class="token operator">&gt;</span>/toggleB \
     -d access_token<span class="token operator">=</span><span class="token operator">&lt;</span>your token<span class="token operator">&gt;</span>
</code></pre></div><p><img src="/assets/img/curlcall.64f3b77c.gif" alt></p><p>You've now explored a number of ways that you can interface with the Particle Device cloud and your connected devices! Now, let's go beyond the Particle ecosystem and explore some of the ways that you can integrate with other 3rd party services, and backhaul your data into other cloud services.</p><h2 id="introducing-the-particle-integrations-and-ifttt"><a href="#introducing-the-particle-integrations-and-ifttt" aria-hidden="true" class="header-anchor">#</a> Introducing the Particle Integrations and IFTTT</h2><h3 id="setting-up-an-ifttt-integration"><a href="#setting-up-an-ifttt-integration" aria-hidden="true" class="header-anchor">#</a> Setting up an IFTTT Integration</h3><p>IFTTT (If This, Then That) is a web-based service that allows you to create integrations via simple conditional statements, called applets. There are hundreds of pre-built services you can leverage, and first-class support for Particle devices. In this section, you're going to create an IFTTT integration that posts a tweet when you press a button on your badge.</p><p><strong>Note</strong>: During the flow below, you'll need to connect both your Particle and Google accounts with IFTTT. When prompted, follow the on-screen instructions to do so.</p><ol><li>Start by heading over to <a href="https://ifttt.com" target="_blank" rel="noopener noreferrer">IFTTT<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and either login, or create a new account.</li></ol><p><img src="/assets/img/ifttt.9d29f5a2.png" alt></p><ol start="2"><li>After logging in, click &quot;New Applet&quot; in the top right of your dashboard.</li></ol><p><img src="/assets/img/newapplet.71f8dec8.png" alt></p><ol start="3"><li>Click the &quot;+this&quot; button.</li></ol><p><img src="/assets/img/ifthis.97cb425e.png" alt></p><ol start="4"><li>In the &quot;Search services&quot; input, type &quot;particle&quot; and click on the Particle card.</li></ol><p><img src="/assets/img/chooseservice.824f7028.png" alt></p><p><img src="/assets/img/chooseparticle.55d9e5c6.png" alt></p><ol start="5"><li>Click on the &quot;New event published&quot; card.</li></ol><p><img src="/assets/img/choosetrigger.c8d13bc1.png" alt></p><ol start="6"><li>In the trigger fields, set the event name as <code>env-vals</code>, leave the Event Content field blank and set the Device name to the name of your device. Click &quot;create trigger.&quot;</li></ol><p><img src="/assets/img/triggerfields.63b5592f.png" alt></p><ol start="7"><li>You've set-up the trigger on the Particle end, now its time for the <strong>That</strong>+ portion of the setup. Click the &quot;+that&quot; button.</li></ol><p><img src="/assets/img/thenthat.5c372b0e.png" alt></p><ol start="8"><li>In the action fields, set the spreadsheet name to &quot;TCEnvVals.&quot; Leave the defaults in the other fields and click &quot;Create action.&quot;</li></ol><p><img src="/assets/img/ifttt-gsheets.6d264d1b.png" alt></p><ol start="9"><li>Click the &quot;Finish&quot; button to create your applet.</li></ol><p><img src="/assets/img/ifttt-reviewpng.f1031ce7.png" alt></p><p><img src="/assets/img/ifttt-live.69ed1629.png" alt></p><p>Now, let's modify our device firmware to publish temp and humidity values.</p><h3 id="refactoring-out-the-blocking-delay"><a href="#refactoring-out-the-blocking-delay" aria-hidden="true" class="header-anchor">#</a> Refactoring out the blocking delay</h3><p>First, let's refactor our firmware to remove the <code>delay</code> in the loop. While the delay approach is common when getting started with creating embedded applications, it's a blocking operation. This means that any calls you make to the device during a delay may timeout before being received.</p><p>One common way to write periodic code without using <code>delay</code> is to use the built-in <code>millis()</code> function and keep track of the elapsed time between the last time you performed an operation (like a temp check) and the wait time between operations.</p><ol><li>First, let's add some global variables to hold the last check time and an interval. Add the following to the top of your project, outside of the <code>setup</code> and <code>loop</code>.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">unsigned</span> <span class="token keyword">long</span> previousCheckMillis <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">long</span> checkInterval <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>Now, in the <code>loop</code>, add a local variable to hold the current time elapsed. The <code>millis()</code> function returns the number of milliseconds that have elapsed since your device began running the current program.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">unsigned</span> <span class="token keyword">long</span> currentMillis <span class="token operator">=</span> <span class="token function">millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="3"><li>Next, remove the <code>delay</code> at the end of your loop function. Then, wrap the rest of the code with an if statement to see if the <code>checkInterval</code> time has elapsed.</li></ol><p>Make sure you also update the <code>previousCheckMillis</code> variable to the current <code>millis</code> time or this <code>if</code> statement will never evaluate to <code>true</code> after the first time it runs.</p><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>currentMillis <span class="token operator">-</span> previousCheckMillis <span class="token operator">&gt;</span> checkInterval<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
  previousCheckMillis <span class="token operator">=</span> <span class="token function">millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* rest of Loop code here */</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>Your <code>loop</code> should now look like this:</p><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">long</span> currentMillis <span class="token operator">=</span> <span class="token function">millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentMillis <span class="token operator">-</span> previousCheckMillis <span class="token operator">&gt;</span> checkInterval<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    previousCheckMillis <span class="token operator">=</span> <span class="token function">millis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    temp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>dht<span class="token punctuation">.</span><span class="token function">getTempFarenheit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    humidity <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>dht<span class="token punctuation">.</span><span class="token function">getHumidity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Serial<span class="token punctuation">.</span><span class="token function">printlnf</span><span class="token punctuation">(</span><span class="token string">&quot;Temp: %f&quot;</span><span class="token punctuation">,</span> temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Serial<span class="token punctuation">.</span><span class="token function">printlnf</span><span class="token punctuation">(</span><span class="token string">&quot;Humidity: %f&quot;</span><span class="token punctuation">,</span> humidity<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">double</span> lightAnalogVal <span class="token operator">=</span> <span class="token function">analogRead</span><span class="token punctuation">(</span>A0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentLightLevel <span class="token operator">=</span> <span class="token function">map</span><span class="token punctuation">(</span>lightAnalogVal<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">4095.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">100.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentLightLevel <span class="token operator">&gt;</span> <span class="token number">50</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      Particle<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&quot;light-meter/level&quot;</span><span class="token punctuation">,</span> <span class="token function">String</span><span class="token punctuation">(</span>currentLightLevel<span class="token punctuation">)</span><span class="token punctuation">,</span> PRIVATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="publishing-a-payload-with-temp-and-humidity-values"><a href="#publishing-a-payload-with-temp-and-humidity-values" aria-hidden="true" class="header-anchor">#</a> Publishing a payload with temp and humidity values</h3><p>Now, let's send the current temp, humidity and light level using a <code>Particle.publish</code> event. You'll sind a single event with all three values in a single JSON object. To do this, you'll use the <code>JSONParserGenerator</code> library.</p><ol><li><p>Open the Workbench Command Palette (CMD+SHIFT+P or CTRL+SHIFT+P) and select the &quot;Particle: Install Library&quot; option.</p></li><li><p>In the text box, type &quot;JsonParserGeneratorRK&quot; and click enter.</p></li><li><p>At the top of your project, add an include statement:</p></li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;JsonParserGeneratorRK.h&quot;</span></span>
</code></pre></div><ol start="4"><li>Add a new function to your app called <code>createEventPayload</code> that takes the temp, humidity and light readings. This function will create an instance of <code>JsonWriterStatic</code> and <code>JsonWriterAutoObject</code> objects, insert key-value pairs for each reading, and then get the JSON object as a string buffer that you can send along in a <code>Particle.publish()</code> event.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">createEventPayload</span><span class="token punctuation">(</span><span class="token keyword">int</span> temp<span class="token punctuation">,</span> <span class="token keyword">int</span> humidity<span class="token punctuation">,</span> <span class="token keyword">double</span> light<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  JsonWriterStatic<span class="token operator">&lt;</span><span class="token number">256</span><span class="token operator">&gt;</span> jw<span class="token punctuation">;</span>
  <span class="token punctuation">{</span>
    JsonWriterAutoObject <span class="token function">obj</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>jw<span class="token punctuation">)</span><span class="token punctuation">;</span>

    jw<span class="token punctuation">.</span><span class="token function">insertKeyValue</span><span class="token punctuation">(</span><span class="token string">&quot;temp&quot;</span><span class="token punctuation">,</span> temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    jw<span class="token punctuation">.</span><span class="token function">insertKeyValue</span><span class="token punctuation">(</span><span class="token string">&quot;humidity&quot;</span><span class="token punctuation">,</span> humidity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    jw<span class="token punctuation">.</span><span class="token function">insertKeyValue</span><span class="token punctuation">(</span><span class="token string">&quot;light&quot;</span><span class="token punctuation">,</span> light<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="5"><li>Now, let's publish a new event, and call the <code>createEventPayload</code> function to provide a formatted JSON string for the data parameter. Add the following to the end of your <code>createEventPayload</code> function.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code>Particle<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&quot;env-vals&quot;</span><span class="token punctuation">,</span> <span class="token function">createEventPayload</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> humidity<span class="token punctuation">,</span> currentLightLevel<span class="token punctuation">)</span><span class="token punctuation">,</span> PRIVATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="posting-sensor-values-to-google-sheets"><a href="#posting-sensor-values-to-google-sheets" aria-hidden="true" class="header-anchor">#</a> Posting sensor values to Google Sheets</h3><ol><li>Flash this firmware to your device and navigate to the Particle console. Every few seconds, you'll see a new <code>env-vals</code> event show up.</li></ol><p><img src="/assets/img/env-vals.003cdde5.png" alt></p><ol start="2"><li>Open Google Drive and look for a folder named &quot;events.&quot; In that folder, you'll find a Sheet called &quot;TCEnvVals.&quot; Open it, and you'll see a row for each event published by your device:</li></ol><p><img src="/assets/img/gsheet.9e35275d.png" alt></p><p>Now that you have data streaming into Google Sheets, let's transform the data and create some simple visualizations!</p><h3 id="processing-data-in-google-sheets"><a href="#processing-data-in-google-sheets" aria-hidden="true" class="header-anchor">#</a> Processing data in Google Sheets</h3><p>Before you create data visualizations with our sensor data, you need to transform the sensor values into discrete values. You'll do this by creating a simple script that processes the raw data as it is added to the main sheet, inserting each raw sensor value in a new sheet for data viz.</p><ol><li><p>In the &quot;TCEnvVals&quot; document, create a new sheet called &quot;Processed&quot; and give it four columns, &quot;Temp,&quot; &quot;Humidity,&quot; &quot;Light&quot; and &quot;Time.&quot;</p></li><li><p>In the Tools menu, click the &quot;Script Editor&quot; option, which will open a new tab with the Google Apps Script editor.</p></li><li><p>Click on the &quot;Untitled project&quot; text and give the project a name, like &quot;ProcessTCSensorData.&quot;</p></li><li><p>Remove the default function code and add an <code>onChange</code> event with the following code.</p></li></ol><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">onChange</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> row <span class="token operator">=</span> SpreadsheetApp<span class="token punctuation">.</span><span class="token function">getActiveSheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLastRow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">var</span> envVals <span class="token operator">=</span> SpreadsheetApp<span class="token punctuation">.</span><span class="token function">getActiveSheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token string">&quot;B&quot;</span> <span class="token operator">+</span> row<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> time <span class="token operator">=</span> SpreadsheetApp<span class="token punctuation">.</span><span class="token function">getActiveSheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRange</span><span class="token punctuation">(</span><span class="token string">&quot;D&quot;</span> <span class="token operator">+</span> row<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">var</span> envObj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>envVals<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>envObj<span class="token punctuation">.</span>temp <span class="token operator">!=</span> <span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> ss <span class="token operator">=</span> SpreadsheetApp<span class="token punctuation">.</span><span class="token function">getActiveSpreadsheet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> processedSheet <span class="token operator">=</span> ss<span class="token punctuation">.</span><span class="token function">getSheetByName</span><span class="token punctuation">(</span><span class="token string">'Processed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    processedSheet<span class="token punctuation">.</span><span class="token function">appendRow</span><span class="token punctuation">(</span><span class="token punctuation">[</span>envObj<span class="token punctuation">.</span>temp<span class="token punctuation">,</span> envObj<span class="token punctuation">.</span>humidity<span class="token punctuation">,</span> envObj<span class="token punctuation">.</span>light<span class="token punctuation">,</span> time<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The code above is a JavaScript function that uses the Google Sheets API to get the last row inserted into the main sheet, extract the sensor vals, and the timestamp. The sensor vals are parsed into a JSON object, and then you add a new row to the &quot;Processed&quot; sheet with those values and the timestamp.</p><ol start="5"><li><p>Save the file.</p></li><li><p>Now, you'll need to add a change trigger to this app. Click the clock icon to open the triggers for this project.</p></li></ol><p><img src="/assets/img/opentriggers.472d5e1f.png" alt></p><ol start="7"><li>Click &quot;Add Trigger&quot; at the bottom left.</li></ol><p><img src="/assets/img/addtrigger.35846ea3.png" alt></p><ol start="8"><li>In the trigger window that opens, make sure that <code>onChange</code> is selected as the function name, and &quot;On change&quot; is selected as the event type.</li></ol><p><img src="/assets/img/addtriggerwindow.e6e28097.png" alt></p><ol start="9"><li>Click save to create the trigger. You'll be asked to sign-in with your Google Account and grant access to your app. Follow the on-screen instructions to do so.</li></ol><p><img src="/assets/img/triggerlist.3a8799cb.png" alt></p><ol start="10"><li>In the tab for your spreadsheet, select the &quot;Processed&quot; sheet. After a few moments, records should start coming through.</li></ol><p><img src="/assets/img/processed.c7097725.png" alt></p><p>If you're not seeing anything after a bit, you can click the &quot;Check now&quot; button in your IFTTT Applet.</p><p><img src="/assets/img/checknow.d0cc9765.png" alt></p><h3 id="vizualizing-data-with-google-sheets"><a href="#vizualizing-data-with-google-sheets" aria-hidden="true" class="header-anchor">#</a> Vizualizing data with Google Sheets</h3><p>Once you have some processed data, you can add a chart to your sheet!</p><ol><li><p>Create a new tab called &quot;DataViz&quot;</p></li><li><p>Click the &quot;Insert&quot; menu and select &quot;Chart.&quot;</p></li></ol><p><img src="/assets/img/chart.ee6b4164.png" alt></p><ol start="3"><li>The Chart menu will open on the right side of the window. In the &quot;Chart type&quot; dropdown, select the combination chart type.</li></ol><p><img src="/assets/img/combochart.5e75f031.png" alt></p><ol start="4"><li>Click the X-Axis box to open the &quot;Select a data range&quot; window. Navigate to the &quot;Processed&quot; sheet and select the top of the Time tab.</li></ol><p><img src="/assets/img/selectX.17f33cc7.gif" alt></p><ol start="5"><li>Click &quot;Add Series&quot; to open the &quot;Select a data range&quot; window.</li></ol><p><img src="/assets/img/addtemp.01caef9f.gif" alt></p><ol start="6"><li>Repeat the same process to add Series data for the &quot;Humidity&quot; and &quot;Light&quot; columns.</li></ol><p><img src="/assets/img/chartfilled.179a960f.png" alt></p><ol start="7"><li>Now let's customize. In the Chart editor, click the &quot;Customize&quot; tab and expand the &quot;Series&quot; item. Select the &quot;Temp&quot; series. Then, change the type to &quot;Line.&quot;</li></ol><p><img src="/assets/img/templine.5a0ac5c7.png" alt></p><ol start="8"><li>Now select the &quot;Light&quot; series and change the type to &quot;Columns.&quot;</li></ol><p><img src="/assets/img/lightline.ad8f851b.png" alt></p><ol start="9"><li>Close the chart editor. If everything has been configured properly, you'll see a chart that looks like this.</li></ol><p><img src="/assets/img/finalchart.6b347941.png" alt></p><p>And that's how you do DataViz with Google Sheets and IFTTT. Now let's explore integrating with Azure IoT Central.</p><h2 id="integrating-with-azure-iot-central"><a href="#integrating-with-azure-iot-central" aria-hidden="true" class="header-anchor">#</a> Integrating with Azure IoT Central</h2><p>IFTTT is a great tool for intrgrating with a variety of 3rd party tools, but sometimes you need to backhaul your data to a cloud provider for additional processing or routing. Thankfully, Particle Integrations make this easy.</p><p>In this section, you'll explore Azure IoT Central, ingest data, and add simple visualizations. First, you'll need to set-up an IoT Hub instance.</p><h3 id="setting-up-azure-iot-central"><a href="#setting-up-azure-iot-central" aria-hidden="true" class="header-anchor">#</a> Setting up Azure IoT Central</h3><ol><li>Sign up for an <a href="https://azure.microsoft.com/en-us/get-started/" target="_blank" rel="noopener noreferrer">Azure Account<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, or sign in if you already have one.</li></ol><p><img src="/assets/img/azureacct.d865c7cf.png" alt></p><ol start="2"><li>In the dashboard, click &quot;Create a resource.&quot; Then click &quot;Internet of Things,&quot; and &quot;IoT Central Application&quot; at the top of the list.</li></ol><p><img src="/assets/img/centrallist.8ddb70eb.png" alt></p><ol start="3"><li>Give the IoT Central Application an name and URL (both must be globally unique). Then, select a subscription, select or create a resource group, choose a pricing tier, &quot;Custom application&quot; for the template, and East US for the location. Finally, click &quot;Create&quot; and wait for the deployment to complete.</li></ol><p><img src="/assets/img/createcentralapp.64bdd90e.png" alt></p><ol start="4"><li><p>When the deployment completes, click the &quot;Go to resource&quot; button in the notification window.</p></li><li><p>Click the URL for your IoT Central Application to open it in a new tab.</p></li></ol><h3 id="adding-device-telemetry-and-commands"><a href="#adding-device-telemetry-and-commands" aria-hidden="true" class="header-anchor">#</a> Adding Device Telemetry and Commands</h3><ol start="6"><li>Click the &quot;Create Device Templates&quot; card on the home page. Click &quot;Custom&quot; in the next screen.</li></ol><p><img src="/assets/img/centralhome.bf1a5283.png" alt></p><ol start="7"><li>Name the template &quot;Particle Argon&quot; and click &quot;Create.&quot;</li></ol><p><img src="/assets/img/templatehome.02b7bb6b.png" alt></p><ol start="8"><li>Click the &quot;New&quot; menu option and select &quot;Telemetry.&quot;</li></ol><p><img src="/assets/img/addtelemetry.fcb4f6cc.png" alt></p><ol start="9"><li>Fill in the telemetry options using the data below and click &quot;Save.&quot;</li></ol><table><thead><tr><th>Display Name</th><th>Field Name</th><th>Units</th><th>Minimum Value</th><th>Maximum Value</th><th>Decimal Places</th></tr></thead><tbody><tr><td>Temperature</td><td>temp</td><td>degF</td><td>0</td><td>110</td><td>0</td></tr></tbody></table><p><img src="/assets/img/createtelemetry.73efb57e.png" alt></p><ol start="10"><li>Repeat steps 8-9 for humidity and light, using the values below.</li></ol><table><thead><tr><th>Display Name</th><th>Field Name</th><th>Units</th><th>Minimum Value</th><th>Maximum Value</th><th>Decimal Places</th></tr></thead><tbody><tr><td>Humidity</td><td>humidity</td><td>%</td><td>0</td><td>100</td><td>0</td></tr><tr><td>Light Level</td><td>light</td><td>%</td><td>0</td><td>100</td><td>2</td></tr></tbody></table><p>Once done, you'll start to see simulated data show up on the right side of the screen.</p><p><img src="/assets/img/alltelemetry.b9e9baba.png" alt></p><ol start="11"><li>Click the &quot;Commands&quot; menu item, then click the &quot;New Command&quot; button.</li></ol><p><img src="/assets/img/newcommand.7c58a418.png" alt></p><ol start="12"><li>In the &quot;Configure Command&quot; section, enter &quot;Read Sensor Vals&quot; for the &quot;Display Name,&quot; and &quot;readSensors&quot; for the &quot;Field Name.&quot; Then, click save.</li></ol><p><img src="/assets/img/valscommand.3d057f29.png" alt></p><ol start="13"><li>Add another command with the name &quot;Toggle LED&quot; and &quot;toggleLed&quot; for the &quot;Field Name.&quot;</li></ol><h3 id="create-a-real-device-in-iot-central"><a href="#create-a-real-device-in-iot-central" aria-hidden="true" class="header-anchor">#</a> Create a Real Device in IoT Central</h3><ol start="14"><li>Click the Device Explorer sidebar menu. Then, click the &quot;+&quot; button and select &quot;Real&quot; to create a real device. This is an IoT Central representation of your physical Argon.</li></ol><p><img src="/assets/img/deviceexplorer.183e4438.png" alt></p><ol start="15"><li>Click &quot;Create.&quot;</li></ol><p><img src="/assets/img/realdevice.dda729f4.png" alt></p><ol start="16"><li>Click the &quot;Connect&quot; menu item at the top right.</li></ol><p><img src="/assets/img/realdevicemain.c392bd33.png" alt></p><ol start="17"><li>Copy the &quot;Primary Key&quot; and &quot;Device ID&quot; from the popup window. You'll need these for the next step.</li></ol><p><img src="/assets/img/devicecreds.c64619db.png" alt></p><ol start="18"><li>Before moving on, you'll need to create a connection string to use in our firmware to connect to Azure IoT Central. To do this, you have two options: 1) The <a href="https://github.com/Azure/dps-keygen" target="_blank" rel="noopener noreferrer">Azure Keygen Utility<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, which must be installed locally, or 2) this <a href="https://github.com/Azure/dps-keygen" target="_blank" rel="noopener noreferrer">Web-based tool<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> from Azure Dev Advocate Dave Glover. The latter is not recommended for production instances, but is fine for this lab.</li></ol><p><img src="/assets/img/keygen.59f500a6.png" alt></p><p>Now, let's update our firmware to integrate with Azure IoT Central!</p><h3 id="using-the-azure-iot-central-device-bridge-library"><a href="#using-the-azure-iot-central-device-bridge-library" aria-hidden="true" class="header-anchor">#</a> Using the Azure IoT Central Device Bridge Library</h3><p>First, you'll need to install a library to work with Azure IoT Central.</p><ol><li><p>Open the Workbench command palette and select the &quot;Particle: Install Library&quot; option.</p></li><li><p>Enter &quot;AzureIotHubClient&quot; for the library name.</p></li><li><p>Once the library is installed, add an include to the top of your project.</p></li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&quot;AzureIotHubClient.h&quot;</span></span>
</code></pre></div><ol start="4"><li>Just below the include, add another line for the connection string. Replace the text in quotes with the string you generated in the last section.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token macro property">#<span class="token directive keyword">define</span> AZURE_CONNECTON_STRING &quot;&lt;Your Azure IoT Hub or Azure IoT Central Connection String&gt;&quot;</span>
</code></pre></div><ol start="5"><li>Next, create a callback method for Azure IoT to use when you call a command from IoT Central, and initialize the Hub object. The second parameter is for a Cloud2Device messages, which you're not using here, so you just set it to <code>NULL</code>.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">int</span> <span class="token function">callbackDirectMethod</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>method<span class="token punctuation">,</span> byte <span class="token operator">*</span>payload<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>

IotHub <span class="token function">hub</span><span class="token punctuation">(</span>AZURE_CONNECTON_STRING<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> callbackDirectMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="6"><li>One of the commands you set-up in IoT Central was <code>readSensors</code>, which you don't have yet, so let's create it. This just uses the same code in the <code>loop</code>, which you could refactor into this function, or leave as-is if you want.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">readSensors</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  temp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>dht<span class="token punctuation">.</span><span class="token function">getTempFarenheit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  humidity <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>dht<span class="token punctuation">.</span><span class="token function">getHumidity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">double</span> lightAnalogVal <span class="token operator">=</span> <span class="token function">analogRead</span><span class="token punctuation">(</span>A0<span class="token punctuation">)</span><span class="token punctuation">;</span>
  currentLightLevel <span class="token operator">=</span> <span class="token function">map</span><span class="token punctuation">(</span>lightAnalogVal<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">4095.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">100.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">createEventPayload</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> humidity<span class="token punctuation">,</span> currentLightLevel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="7"><li>Now, let's define the <code>callbackDirectMethod</code> function. You set-up two methods in IoT Central, named <code>readSensors</code> and <code>toggleLed</code> (which is also the name of our <code>Particle.function</code> from the last lab). Azure IoT passes the method name in as a string, so you can determine which method is called using the <code>strcmp</code> C function, which returns <code>0</code> if the strings match. If you get a match, you'll publish a debug message to the Particle Device Cloud and then call the appropriate function. Finally, you'll return a 200 HTTP Status Code, or a 400 if the method string doesn't match what you expect.</li></ol><div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">int</span> <span class="token function">callbackDirectMethod</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>method<span class="token punctuation">,</span> byte <span class="token operator">*</span>payload<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> payloadLength<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token string">&quot;readSensors&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    Particle<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&quot;iot-central/debug&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Read Sensors from IoT Central!&quot;</span><span class="token punctuation">,</span> PRIVATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">readSensors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token string">&quot;toggleLed&quot;</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    Particle<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&quot;iot-central/debug&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Toggle LED from IoT Central!&quot;</span><span class="token punctuation">,</span> PRIVATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">toggleLed</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">400</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">200</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="8"><li>Now, let's modify the firmware to send telemetry data to Azure IoT Central. You'll need to modify the <code>createEventPayload</code> method to publish an event to Azure IoT, in addition to the Particle Device Cloud. The <code>hub.loop()</code> method checks to make sure you're connected to Azure IoT and, if so, it adds the Azure Device ID to the payload and sends a debug message to the Particle Device Cloud. Finally, <code>hub.publish()</code> sends the payload with our telemetry data to Azure IoT.</li></ol><div class="language-cpp extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br></div><pre class="language-cpp"><code><span class="token keyword">void</span> <span class="token function">createEventPayload</span><span class="token punctuation">(</span><span class="token keyword">int</span> temp<span class="token punctuation">,</span> <span class="token keyword">int</span> humidity<span class="token punctuation">,</span> <span class="token keyword">double</span> light<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  JsonWriterStatic<span class="token operator">&lt;</span><span class="token number">256</span><span class="token operator">&gt;</span> jw<span class="token punctuation">;</span>
  <span class="token punctuation">{</span>
    JsonWriterAutoObject <span class="token function">obj</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>jw<span class="token punctuation">)</span><span class="token punctuation">;</span>

    jw<span class="token punctuation">.</span><span class="token function">insertKeyValue</span><span class="token punctuation">(</span><span class="token string">&quot;temp&quot;</span><span class="token punctuation">,</span> temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    jw<span class="token punctuation">.</span><span class="token function">insertKeyValue</span><span class="token punctuation">(</span><span class="token string">&quot;humidity&quot;</span><span class="token punctuation">,</span> humidity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    jw<span class="token punctuation">.</span><span class="token function">insertKeyValue</span><span class="token punctuation">(</span><span class="token string">&quot;light&quot;</span><span class="token punctuation">,</span> light<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hub<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      Particle<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&quot;iot-central/debug&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Sending Env Vals&quot;</span><span class="token punctuation">,</span> PRIVATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
      jw<span class="token punctuation">.</span><span class="token function">insertKeyValue</span><span class="token punctuation">(</span><span class="token string">&quot;deviceid&quot;</span><span class="token punctuation">,</span> hub<span class="token punctuation">.</span><span class="token function">getDeviceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      Particle<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&quot;iot-central/debug&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;IoT Hub Not Connected!&quot;</span><span class="token punctuation">,</span> PRIVATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>hub<span class="token punctuation">.</span><span class="token function">loop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
     hub<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>jw<span class="token punctuation">.</span><span class="token function">getBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  Particle<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token string">&quot;env-vals&quot;</span><span class="token punctuation">,</span> jw<span class="token punctuation">.</span><span class="token function">getBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> PRIVATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="9"><li>Flash your device and, once it comes online, you should see your Azure IoT debug messages in the Particle Console.</li></ol><p><img src="/assets/img/consoledebug.a880624b.png" alt></p><ol start="10"><li>Navigate back to your Azure IoT Central application and click the &quot;Devices&quot; menu item. Click on your real device (not the simulated device) and you'll be taken to the telemetry dashboard, which will provide a live view of incoming data from your device.</li></ol><p><img src="/assets/img/telemetry.d078381a.png" alt></p><ol start="11"><li>Now, click the &quot;Commands&quot; menu item for your device, which should show the two commands you set-up in the device template. Click &quot;Run&quot; on the &quot;Toggle LED&quot; command.</li></ol><p><img src="/assets/img/commands.4bc141e5.png" alt></p><ol start="12"><li>After the command completes, the LED on your device should light up, and you'll see a debug message in the Particle Console.</li></ol><p><img src="/assets/img/leddebug.89580833.png" alt></p><p>Now that everything is configured and you're streaming sensor data into Azure IoT Central, let's build some more visualizations.</p><h3 id="building-visualizations-in-iot-central"><a href="#building-visualizations-in-iot-central" aria-hidden="true" class="header-anchor">#</a> Building Visualizations in IoT Central</h3><p>To build dashboard visualizations for our Particle Device, you'll need to edit the device template.</p><ol><li>Click on the &quot;Device Templates&quot; menu item in IoT Central and click on your &quot;Particle Argon&quot; template.</li></ol><p><img src="/assets/img/templates.320da835.png" alt></p><ol start="2"><li>Click the &quot;Dashboard&quot; menu item.</li></ol><p><img src="/assets/img/widgets.2ecc7e3c.png" alt></p><ol start="3"><li>Click the &quot;Last Known Value&quot; widget. In the configuration window, set the title to &quot;Last Temp,&quot; the measurement type to &quot;Telemetry&quot; and, in &quot;Measures&quot;, click the visibility icon next to &quot;Temperature&quot; to select it.</li></ol><p><img src="/assets/img/lasttemp.dba58560.png" alt></p><ol start="4"><li>Click save, and the widget will show up in the main panel, with simulated data.</li></ol><p><img src="/assets/img/lasttempsim.652de76e.png" alt></p><ol start="5"><li>Repeat steps 3 and 4 for the humidity and light sensor values.</li></ol><p><img src="/assets/img/allsensors.19d939a8.png" alt></p><ol start="6"><li>Now, click the &quot;Line Chart&quot; widget. In the configuration window, enter &quot;Env Vals&quot; as the title, set a time range to the past hour, and click the visibility icon for all three values to select them.</li></ol><p><img src="/assets/img/createchart.8fa90bad.png" alt></p><ol start="7"><li>Click save and the chart will be created, again with simulated data.</li></ol><p><img src="/assets/img/allwidgets.17c3d9a0.png" alt></p><ol start="8"><li>Click on the &quot;Devices&quot; left menu item, and select your real device. Click the &quot;Dashboard&quot; top menu item and you'll see the real values from your Particle Argon.</li></ol><p><img src="/assets/img/realdashboard.775b88ee.png" alt></p><hr><p><strong>Congratulations! You've completed this workshop. Now you're a Particle Master! Take a moment to pat yourself on the back and bask in your newfound IoT-commandery. And if you want to take your exploration further, click the &quot;Extra&quot; link below!</strong></p><p><strong>BEFORE YOU GO</strong> you'd love it if you could provide feedback on this workshop. Please visit <a href="https://particleiot.typeform.com/to/JiF8xM" target="_blank" rel="noopener noreferrer">this link<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to rate your experience.</p></div><div class="page-edit"><div class="edit-link"><a href="https://github.com/bsatrom/thatconf-workshop-2019/edit/master/docs/ch3.md" target="_blank" rel="noopener noreferrer">Help us improve this page!</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><!----></div><div class="page-nav"><p class="inner"><span class="prev">
        ← <a href="/docs/ch2.html" class="prev">
          Chapter 2: Working with Particle primitives &amp; Grove Sensors
        </a></span><span class="next"><a href="/docs/extra.html">
          Extra: Going Even Further!
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/1.5a60c874.js" defer></script><script src="/assets/js/app.1eff5426.js" defer></script>
  </body>
</html>
